<!DOCTYPE html>
<html lang="zh-CN">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>图片转 WebP 工具</title>
    <script src="https://cdn.tailwindcss.com"></script>
    <style>
        .drop-zone {
            border: 2px dashed #e5e7eb;
            transition: all 0.3s ease;
        }
        .drop-zone.dragover {
            border-color: #3b82f6;
            background-color: #eff6ff;
        }
    </style>
</head>
<body class="bg-gray-50 min-h-screen flex flex-col">

    <!-- Header -->
    <header class="bg-white border-b border-gray-200 px-6 py-4 mb-8">
        <div class="max-w-4xl mx-auto flex justify-between items-center">
            <h1 class="text-xl font-bold text-gray-900">图片转 WebP 工具</h1>
            <a href="/" class="text-sm text-gray-500 hover:text-blue-600 transition-colors">← 返回首页</a>
        </div>
    </header>

    <main class="flex-grow w-full max-w-4xl mx-auto px-6 mb-12">
        
        <!-- Upload Section -->
        <section class="bg-white rounded-xl shadow-sm border border-gray-200 p-8 mb-8">
            <div id="drop-zone" class="drop-zone rounded-lg p-12 text-center cursor-pointer">
                <input type="file" id="file-input" class="hidden" multiple accept="image/png, image/jpeg, image/jpg">
                <div class="pointer-events-none">
                    <svg class="w-12 h-12 text-gray-400 mx-auto mb-4" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                        <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M4 16l4.586-4.586a2 2 0 012.828 0L16 16m-2-2l1.586-1.586a2 2 0 012.828 0L20 14m-6-6h.01M6 20h12a2 2 0 002-2V6a2 2 0 00-2-2H6a2 2 0 00-2 2v12a2 2 0 002 2z"></path>
                    </svg>
                    <p class="text-lg text-gray-700 font-medium mb-1">点击或拖拽图片到这里</p>
                    <p class="text-sm text-gray-500">支持 JPG, PNG 格式</p>
                </div>
            </div>

            <!-- Settings -->
            <div class="mt-6 flex items-center gap-4">
                <label for="quality" class="text-sm font-medium text-gray-700">压缩质量 (0-100):</label>
                <div class="flex items-center gap-3 flex-1 max-w-xs">
                    <input type="range" id="quality" min="0" max="100" value="80" class="w-full h-2 bg-gray-200 rounded-lg appearance-none cursor-pointer">
                    <span id="quality-value" class="text-sm font-mono text-gray-600 w-8">80</span>
                </div>
            </div>
        </section>

        <!-- Results Section -->
        <section id="results-area" class="space-y-4 hidden">
            <div class="flex justify-between items-center mb-2">
                <h2 class="text-lg font-semibold text-gray-900">转换结果</h2>
                <button id="clear-all" class="text-sm text-red-500 hover:text-red-700 hover:underline">清空列表</button>
            </div>
            <!-- Image Item Template (Hidden) -->
            <template id="result-item-template">
                <div class="bg-white rounded-lg border border-gray-200 p-4 flex items-center gap-6 shadow-sm">
                    <div class="w-24 h-24 bg-gray-100 rounded-md overflow-hidden flex-shrink-0 border border-gray-200">
                        <img src="" alt="Preview" class="w-full h-full object-cover">
                    </div>
                    
                    <div class="flex-grow min-w-0">
                        <h3 class="text-sm font-medium text-gray-900 truncate mb-1 name">filename.jpg</h3>
                        <div class="flex items-center text-xs text-gray-500 gap-4 mb-2">
                            <span>原始: <span class="original-size font-mono">2.4 MB</span></span>
                            <span>→</span>
                            <span>WebP: <span class="new-size font-mono font-bold text-gray-800">1.2 MB</span></span>
                        </div>
                        <div class="inline-flex items-center px-2 py-0.5 rounded text-xs font-medium bg-green-100 text-green-800 savings">
                            节省 50%
                        </div>
                    </div>

                    <div class="flex-shrink-0">
                        <a href="#" download class="download-btn inline-flex items-center px-4 py-2 border border-transparent text-sm font-medium rounded-md shadow-sm text-white bg-blue-600 hover:bg-blue-700 focus:outline-none focus:ring-2 focus:ring-offset-2 focus:ring-blue-500 transition-colors">
                            下载 WebP
                        </a>
                    </div>
                </div>
            </template>
            
            <div id="results-list" class="space-y-4"></div>
        </section>

    </main>

    <!-- Footer -->
    <footer class="mt-auto bg-white border-t border-gray-200 py-6">
        <nav class="flex justify-center space-x-6 text-xs text-gray-600">
            <a href="/" class="hover:text-blue-600 underline">首页</a>
            <a href="https://github.com/xuchunyang/tools/blob/main/cwebp.html" class="hover:text-blue-600 underline" target="_blank">查看源码</a>
            <span class="text-gray-400">生成于 2025-12-19</span>
        </nav>
    </footer>

    <script>
        const els = {
            dropZone: document.getElementById('drop-zone'),
            fileInput: document.getElementById('file-input'),
            qualityInput: document.getElementById('quality'),
            qualityValue: document.getElementById('quality-value'),
            resultsArea: document.getElementById('results-area'),
            resultsList: document.getElementById('results-list'),
            template: document.getElementById('result-item-template'),
            clearBtn: document.getElementById('clear-all')
        };

        // Quality slider
        els.qualityInput.addEventListener('input', (e) => {
            els.qualityValue.textContent = e.target.value;
        });

        // Drag & Drop
        els.dropZone.addEventListener('click', () => els.fileInput.click());
        els.dropZone.addEventListener('dragover', (e) => {
            e.preventDefault();
            els.dropZone.classList.add('dragover');
        });
        els.dropZone.addEventListener('dragleave', () => els.dropZone.classList.remove('dragover'));
        els.dropZone.addEventListener('drop', (e) => {
            e.preventDefault();
            els.dropZone.classList.remove('dragover');
            handleFiles(e.dataTransfer.files);
        });
        els.fileInput.addEventListener('change', (e) => handleFiles(e.target.files));

        // Clear All
        els.clearBtn.addEventListener('click', () => {
            els.resultsList.innerHTML = '';
            els.resultsArea.classList.add('hidden');
            els.fileInput.value = ''; // Reset input
        });

        async function handleFiles(files) {
            if (!files.length) return;
            
            els.resultsArea.classList.remove('hidden');
            const quality = parseInt(els.qualityInput.value) / 100;

            for (const file of files) {
                if (!file.type.match('image.*')) continue;
                await processImage(file, quality);
            }
        }

        function formatSize(bytes) {
            if (bytes === 0) return '0 B';
            const k = 1024;
            const sizes = ['B', 'KB', 'MB', 'GB'];
            const i = Math.floor(Math.log(bytes) / Math.log(k));
            return parseFloat((bytes / Math.pow(k, i)).toFixed(2)) + ' ' + sizes[i];
        }

        function processImage(file, quality) {
            return new Promise((resolve) => {
                const reader = new FileReader();
                reader.readAsDataURL(file);
                reader.onload = (e) => {
                    const img = new Image();
                    img.src = e.target.result;
                    img.onload = () => {
                        const canvas = document.createElement('canvas');
                        canvas.width = img.width;
                        canvas.height = img.height;
                        const ctx = canvas.getContext('2d');
                        ctx.drawImage(img, 0, 0);

                        canvas.toBlob((blob) => {
                            if (!blob) {
                                console.error('Conversion failed');
                                resolve();
                                return;
                            }
                            
                            addResultItem(file, blob, img.src);
                            resolve();
                        }, 'image/webp', quality);
                    };
                };
            });
        }

        function addResultItem(originalFile, newBlob, previewSrc) {
            const clone = els.template.content.cloneNode(true);
            const fileNameWithoutExt = originalFile.name.split('.').slice(0, -1).join('.');
            
            // Set content
            clone.querySelector('.name').textContent = originalFile.name;
            clone.querySelector('img').src = previewSrc; // Use original for preview (faster) or URL.createObjectURL(newBlob)
            clone.querySelector('.original-size').textContent = formatSize(originalFile.size);
            clone.querySelector('.new-size').textContent = formatSize(newBlob.size);
            
            // Calculate savings
            const savings = ((originalFile.size - newBlob.size) / originalFile.size * 100).toFixed(1);
            const savingsEl = clone.querySelector('.savings');
            if (savings > 0) {
                savingsEl.textContent = `节省 ${savings}%`;
                savingsEl.className = 'inline-flex items-center px-2 py-0.5 rounded text-xs font-medium bg-green-100 text-green-800';
            } else {
                savingsEl.textContent = `变大 ${Math.abs(savings)}%`;
                savingsEl.className = 'inline-flex items-center px-2 py-0.5 rounded text-xs font-medium bg-red-100 text-red-800';
            }

            // Setup download
            const downloadBtn = clone.querySelector('.download-btn');
            const url = URL.createObjectURL(newBlob);
            downloadBtn.href = url;
            downloadBtn.download = `${fileNameWithoutExt}.webp`;

            els.resultsList.prepend(clone);
        }
    </script>
</body>
</html>