<!DOCTYPE html>
<html lang="zh-CN">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>LLM Chat Studio</title>
    <link rel="preconnect" href="https://fonts.googleapis.com">
    <link rel="preconnect" href="https://fonts.gstatic.com" crossorigin>
    <link href="https://fonts.googleapis.com/css2?family=Bricolage+Grotesque:wght@300;400;500;600;700&family=Newsreader:opsz,wght@6..72,500;6..72,700&display=swap" rel="stylesheet">
    <link href="https://cdnjs.cloudflare.com/ajax/libs/highlight.js/11.9.0/styles/github-dark.min.css" rel="stylesheet">
    <style>
        :root {
            color-scheme: light;
            --bg: #f5f0ea;
            --bg-deep: #efe7dc;
            --panel: rgba(255, 252, 248, 0.9);
            --ink: #1f1b17;
            --ink-soft: #5b5149;
            --accent: #2a6f6a;
            --accent-strong: #1f4e4a;
            --accent-wash: #d3ebe6;
            --sun: #f2b479;
            --stroke: rgba(31, 27, 23, 0.14);
            --shadow: 0 20px 60px rgba(31, 27, 23, 0.12);
        }

        * {
            box-sizing: border-box;
        }

        body {
            margin: 0;
            font-family: "Bricolage Grotesque", "Noto Sans SC", sans-serif;
            color: var(--ink);
            background: var(--bg);
            min-height: 100vh;
            display: flex;
            flex-direction: column;
            position: relative;
            overflow-x: hidden;
        }

        body::before {
            content: "";
            position: fixed;
            inset: 0;
            background:
                radial-gradient(40% 40% at 15% 15%, rgba(42, 111, 106, 0.18), transparent 60%),
                radial-gradient(45% 45% at 85% 10%, rgba(242, 180, 121, 0.22), transparent 65%),
                radial-gradient(30% 30% at 75% 85%, rgba(112, 146, 180, 0.16), transparent 60%);
            z-index: -2;
        }

        body::after {
            content: "";
            position: fixed;
            inset: 0;
            background-image: url("data:image/svg+xml,%3Csvg xmlns='http://www.w3.org/2000/svg' width='140' height='140'%3E%3Cfilter id='n'%3E%3CfeTurbulence type='fractalNoise' baseFrequency='0.7' numOctaves='2' stitchTiles='stitch'/%3E%3C/filter%3E%3Crect width='140' height='140' filter='url(%23n)' opacity='0.12'/%3E%3C/svg%3E");
            opacity: 0.32;
            pointer-events: none;
            z-index: -1;
        }

        a {
            color: inherit;
            text-decoration: none;
        }

        .page {
            width: min(1200px, 92vw);
            margin: 28px auto 48px;
            display: flex;
            flex-direction: column;
            gap: 22px;
        }

        .topbar {
            display: flex;
            align-items: center;
            justify-content: space-between;
            padding: 14px 18px;
            border-radius: 999px;
            border: 1px solid var(--stroke);
            background: rgba(255, 252, 248, 0.88);
            backdrop-filter: blur(10px);
            box-shadow: 0 16px 32px rgba(31, 27, 23, 0.1);
        }

        .brand {
            display: flex;
            align-items: center;
            gap: 12px;
            font-weight: 600;
            letter-spacing: 0.02em;
        }

        .brand-badge {
            width: 38px;
            height: 38px;
            border-radius: 12px;
            display: inline-flex;
            align-items: center;
            justify-content: center;
            font-family: "Newsreader", serif;
            font-size: 1.1rem;
            background: linear-gradient(140deg, var(--accent), #52a69d);
            color: #fdfbf7;
        }

        .status-pill {
            display: inline-flex;
            align-items: center;
            gap: 6px;
            padding: 6px 12px;
            border-radius: 999px;
            background: var(--accent-wash);
            color: var(--accent-strong);
            font-size: 0.85rem;
            font-weight: 600;
        }

        .layout {
            display: grid;
            grid-template-columns: minmax(0, 320px) minmax(0, 1fr);
            gap: 20px;
            align-items: start;
        }

        .panel {
            background: var(--panel);
            border: 1px solid var(--stroke);
            border-radius: 24px;
            padding: 20px;
            box-shadow: var(--shadow);
        }

        .panel h2 {
            margin: 0 0 12px;
            font-family: "Newsreader", serif;
            font-size: 1.3rem;
        }

        .panel p {
            margin: 0 0 16px;
            color: var(--ink-soft);
            line-height: 1.6;
        }

        .field {
            display: flex;
            flex-direction: column;
            gap: 6px;
            margin-bottom: 14px;
        }

        .field label {
            font-size: 0.85rem;
            letter-spacing: 0.03em;
            text-transform: uppercase;
            color: var(--ink-soft);
        }

        .field input,
        .field textarea,
        .field select {
            border-radius: 14px;
            border: 1px solid var(--stroke);
            padding: 10px 12px;
            font-size: 0.95rem;
            font-family: inherit;
            background: rgba(255, 255, 255, 0.8);
        }

        .field textarea {
            resize: vertical;
            min-height: 80px;
        }

        .field select {
            appearance: none;
            background-image: linear-gradient(45deg, transparent 50%, var(--ink-soft) 50%),
                linear-gradient(135deg, var(--ink-soft) 50%, transparent 50%),
                linear-gradient(to right, transparent, transparent);
            background-position: calc(100% - 18px) calc(1em + 2px),
                calc(100% - 12px) calc(1em + 2px),
                100% 0;
            background-size: 6px 6px, 6px 6px, 2.5em 2.5em;
            background-repeat: no-repeat;
        }

        .field-inline {
            display: grid;
            grid-template-columns: repeat(2, minmax(0, 1fr));
            gap: 10px;
        }

        .toggle {
            display: inline-flex;
            align-items: center;
            gap: 8px;
            font-size: 0.9rem;
            color: var(--ink-soft);
        }

        .toggle input {
            width: 18px;
            height: 18px;
        }

        .hint {
            font-size: 0.8rem;
            color: var(--ink-soft);
        }

        .actions {
            display: flex;
            gap: 10px;
            flex-wrap: wrap;
        }

        .btn {
            border-radius: 999px;
            border: 1px solid transparent;
            padding: 8px 16px;
            font-size: 0.9rem;
            font-weight: 600;
            cursor: pointer;
            transition: all 0.2s ease;
        }

        .btn-primary {
            background: var(--accent-strong);
            color: #fdfbf7;
        }

        .btn-primary:hover,
        .btn-primary:focus-visible {
            transform: translateY(-1px);
            box-shadow: 0 12px 24px rgba(31, 27, 23, 0.18);
        }

        .btn-ghost {
            background: transparent;
            border-color: var(--stroke);
            color: var(--ink);
        }

        .chat-panel {
            display: flex;
            flex-direction: column;
            min-height: 70vh;
            gap: 18px;
        }

        .chat-header {
            display: flex;
            align-items: center;
            justify-content: space-between;
            gap: 12px;
        }

        .chat-title {
            display: flex;
            flex-direction: column;
            gap: 4px;
        }

        .chat-title h2 {
            margin: 0;
            font-family: "Newsreader", serif;
            font-size: 1.4rem;
        }

        .chat-title span {
            color: var(--ink-soft);
            font-size: 0.9rem;
        }

        .chat-window {
            flex: 1;
            overflow-y: auto;
            padding: 10px 4px 0;
            display: flex;
            flex-direction: column;
            gap: 14px;
        }

        .message {
            display: flex;
            gap: 12px;
            align-items: flex-start;
        }

        .avatar {
            width: 36px;
            height: 36px;
            border-radius: 12px;
            display: flex;
            align-items: center;
            justify-content: center;
            font-weight: 700;
            color: #fff;
            flex-shrink: 0;
        }

        .avatar.user {
            background: linear-gradient(140deg, #1d4d7a, #2a7ca8);
        }

        .avatar.assistant {
            background: linear-gradient(140deg, var(--accent-strong), #5aa398);
        }

        .bubble {
            background: #fff;
            border-radius: 16px;
            padding: 12px 14px;
            border: 1px solid var(--stroke);
            box-shadow: 0 10px 24px rgba(31, 27, 23, 0.08);
            max-width: 80%;
            line-height: 1.6;
        }

        .message.user {
            align-self: flex-end;
            flex-direction: row-reverse;
        }

        .message.user .bubble {
            background: #f2f7f6;
        }

        .bubble h1,
        .bubble h2,
        .bubble h3 {
            font-family: "Newsreader", serif;
            margin: 0.4em 0 0.2em;
        }

        .bubble p {
            margin: 0.4em 0;
        }

        .bubble ul,
        .bubble ol {
            margin: 0.4em 0 0.4em 1.2em;
            padding: 0;
        }

        .bubble table {
            width: 100%;
            border-collapse: collapse;
            margin: 0.6em 0;
            font-size: 0.95rem;
        }

        .bubble th,
        .bubble td {
            border: 1px solid var(--stroke);
            padding: 8px 10px;
            text-align: left;
        }

        .bubble th {
            background: var(--bg-deep);
        }

        .bubble a {
            color: var(--accent-strong);
            text-decoration: underline;
        }

        .code-block {
            position: relative;
            margin: 0.6em 0;
            border-radius: 14px;
            border: 1px solid var(--stroke);
            background: #0f172a;
            overflow: hidden;
        }

        .code-block pre {
            margin: 0;
            padding: 14px 16px;
            overflow-x: auto;
            color: #e2e8f0;
            font-size: 0.9rem;
        }

        .code-block button {
            position: absolute;
            top: 10px;
            right: 10px;
            border: none;
            border-radius: 999px;
            padding: 4px 10px;
            font-size: 0.75rem;
            font-weight: 600;
            background: rgba(255, 255, 255, 0.14);
            color: #f8fafc;
            cursor: pointer;
        }


        .composer {
            border-radius: 20px;
            border: 1px solid var(--stroke);
            padding: 12px;
            background: #fff;
            box-shadow: 0 16px 32px rgba(31, 27, 23, 0.1);
            display: flex;
            flex-direction: column;
            gap: 10px;
        }

        .composer textarea {
            border: none;
            outline: none;
            resize: none;
            font-family: inherit;
            font-size: 1rem;
            min-height: 90px;
            background: transparent;
        }

        .composer-footer {
            display: flex;
            align-items: center;
            justify-content: space-between;
            gap: 12px;
        }

        .composer-actions {
            display: flex;
            gap: 10px;
            align-items: center;
        }

        .tag {
            font-size: 0.78rem;
            padding: 4px 10px;
            border-radius: 999px;
            border: 1px solid var(--stroke);
            background: var(--bg-deep);
        }

        .empty-state {
            padding: 24px;
            border-radius: 18px;
            border: 1px dashed var(--stroke);
            background: rgba(255, 255, 255, 0.7);
            color: var(--ink-soft);
            line-height: 1.6;
        }

        .notice {
            font-size: 0.85rem;
            color: var(--ink-soft);
        }

        @media (max-width: 960px) {
            .layout {
                grid-template-columns: minmax(0, 1fr);
            }

            .panel {
                order: 2;
            }

            .chat-panel {
                order: 1;
            }
        }
    </style>
</head>
<body>
    <div class="page">
        <header class="topbar">
            <div class="brand">
                <div class="brand-badge">LL</div>
                <div>
                    <div>LLM Chat Studio</div>
                    <div class="hint">OpenAI 兼容接口 · 本地保存配置</div>
                </div>
            </div>
            <div class="status-pill" id="connectionStatus">准备就绪</div>
        </header>

        <div class="layout">
            <section class="panel" aria-label="设置">
                <h2>连接与参数</h2>
                <p>支持 OpenAI 兼容接口。配置会自动保存在浏览器 localStorage 中。</p>

                <div class="field">
                    <label for="endpoint">Endpoint</label>
                    <input id="endpoint" type="text" placeholder="https://api.openai.com/v1/chat/completions">
                    <div class="hint">如果你的服务使用 Base URL，请填写完整的 `/v1/chat/completions` 路径。</div>
                </div>

                <div class="field">
                    <label for="provider">常见提供商</label>
                    <select id="provider">
                        <option value="">手动输入</option>
                    </select>
                    <div class="hint">选择后会自动填充 Endpoint / Model，可继续手动修改。</div>
                </div>

                <div class="field">
                    <label for="apiKey">API Key</label>
                    <input id="apiKey" type="password" placeholder="sk-...">
                </div>

                <div class="field">
                    <label for="model">Model</label>
                    <input id="model" type="text" placeholder="gpt-4o-mini">
                </div>

                <div class="field-inline">
                    <div class="field">
                        <label for="temperature">Temperature</label>
                        <input id="temperature" type="number" min="0" max="2" step="0.1">
                    </div>
                    <div class="field">
                        <label for="topP">Top P</label>
                        <input id="topP" type="number" min="0" max="1" step="0.05">
                    </div>
                </div>

                <div class="field-inline">
                    <div class="field">
                        <label for="maxTokens">Max Tokens</label>
                        <input id="maxTokens" type="number" min="1" step="1">
                    </div>
                    <div class="field">
                        <label>Streaming</label>
                        <label class="toggle">
                            <input id="stream" type="checkbox">
                            启用流式输出
                        </label>
                    </div>
                </div>

                <div class="field">
                    <label for="systemPrompt">System Prompt</label>
                    <textarea id="systemPrompt" placeholder="定义角色、语气、限制等"></textarea>
                </div>


                <div class="actions">
                    <button class="btn btn-ghost" id="clearChat">清空对话</button>
                    <button class="btn btn-ghost" id="resetSettings">恢复默认</button>
                </div>
                <div class="notice" id="saveNotice">配置已自动保存。</div>
            </section>

            <section class="panel chat-panel" aria-label="聊天">
                <div class="chat-header">
                    <div class="chat-title">
                        <h2>对话窗口</h2>
                        <span>像 ChatGPT 一样对话，支持历史上下文。</span>
                    </div>
                    <div class="actions">
                        <button class="btn btn-ghost" id="stopStream">停止输出</button>
                        <button class="btn btn-primary" id="sendQuick">发送</button>
                    </div>
                </div>

                <div class="chat-window" id="chatWindow">
                    <div class="empty-state" id="emptyState">
                        开始输入第一条消息。系统会把当前对话上下文一起发送到模型。
                    </div>
                </div>

                <div class="composer">
                    <textarea id="userInput" placeholder="输入内容，Enter 发送，Shift+Enter 换行"></textarea>
                    <div class="composer-footer">
                        <div class="composer-actions">
                            <span class="tag" id="modelTag">Model: -</span>
                            <span class="tag" id="endpointTag">Endpoint: -</span>
                        </div>
                        <button class="btn btn-primary" id="sendButton">发送</button>
                    </div>
                </div>
            </section>
        </div>
    </div>

    <script src="https://cdnjs.cloudflare.com/ajax/libs/marked/12.0.1/marked.min.js"></script>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/dompurify/3.0.9/purify.min.js"></script>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/highlight.js/11.9.0/highlight.min.js"></script>
    <script>
        const SETTINGS_KEY = "llm_chat_settings";
        const MESSAGES_KEY = "llm_chat_messages";

        const defaultSettings = {
            endpoint: "https://api.openai.com/v1/chat/completions",
            apiKey: "",
            model: "gpt-4o-mini",
            temperature: 0.6,
            topP: 1,
            maxTokens: 800,
            stream: true,
            systemPrompt: ""
        };

        const state = {
            settings: { ...defaultSettings },
            messages: [],
            controller: null,
            isStreaming: false,
            isComposing: false
        };

        const elements = {
            endpoint: document.getElementById("endpoint"),
            provider: document.getElementById("provider"),
            apiKey: document.getElementById("apiKey"),
            model: document.getElementById("model"),
            temperature: document.getElementById("temperature"),
            topP: document.getElementById("topP"),
            maxTokens: document.getElementById("maxTokens"),
            stream: document.getElementById("stream"),
            systemPrompt: document.getElementById("systemPrompt"),
            chatWindow: document.getElementById("chatWindow"),
            emptyState: document.getElementById("emptyState"),
            userInput: document.getElementById("userInput"),
            sendButton: document.getElementById("sendButton"),
            sendQuick: document.getElementById("sendQuick"),
            stopStream: document.getElementById("stopStream"),
            clearChat: document.getElementById("clearChat"),
            resetSettings: document.getElementById("resetSettings"),
            modelTag: document.getElementById("modelTag"),
            endpointTag: document.getElementById("endpointTag"),
            connectionStatus: document.getElementById("connectionStatus"),
            saveNotice: document.getElementById("saveNotice")
        };

        marked.setOptions({
            gfm: true,
            breaks: true
        });

        const PROVIDERS = [
            {
                id: "openai",
                label: "OpenAI",
                endpoint: "https://api.openai.com/v1/chat/completions",
                model: "gpt-4o-mini"
            },
            {
                id: "azure-openai",
                label: "Azure OpenAI (Chat Completions)",
                endpoint: "https://{resource}.openai.azure.com/openai/deployments/{deployment}/chat/completions?api-version=2024-02-15-preview",
                model: "your-deployment-name"
            },
            {
                id: "openai-compatible",
                label: "OpenAI-Compatible (Base)",
                endpoint: "https://your-endpoint/v1/chat/completions",
                model: "gpt-4o-mini"
            },
            {
                id: "anthropic",
                label: "Anthropic (兼容代理)",
                endpoint: "https://your-endpoint/v1/chat/completions",
                model: "claude-3-5-sonnet"
            },
            {
                id: "google",
                label: "Google Gemini (兼容代理)",
                endpoint: "https://your-endpoint/v1/chat/completions",
                model: "gemini-1.5-pro"
            },
            {
                id: "qwen-dashscope-cn",
                label: "阿里云 DashScope (中国)",
                endpoint: "https://dashscope.aliyuncs.com/compatible-mode/v1/chat/completions",
                model: "qwen-plus"
            },
            {
                id: "qwen-dashscope-intl",
                label: "阿里云 DashScope (新加坡)",
                endpoint: "https://dashscope-intl.aliyuncs.com/compatible-mode/v1/chat/completions",
                model: "qwen-plus"
            },
            {
                id: "zhipu",
                label: "智谱 AI (兼容代理)",
                endpoint: "https://your-endpoint/v1/chat/completions",
                model: "glm-4"
            },
            {
                id: "moonshot",
                label: "Moonshot (兼容代理)",
                endpoint: "https://your-endpoint/v1/chat/completions",
                model: "moonshot-v1-8k"
            },
            {
                id: "deepseek",
                label: "DeepSeek (兼容代理)",
                endpoint: "https://your-endpoint/v1/chat/completions",
                model: "deepseek-chat"
            },
            {
                id: "baidu",
                label: "百度千帆 (兼容代理)",
                endpoint: "https://your-endpoint/v1/chat/completions",
                model: "ernie-4.0"
            }
        ];

        function loadSettings() {
            const saved = localStorage.getItem(SETTINGS_KEY);
            if (saved) {
                try {
                    state.settings = { ...defaultSettings, ...JSON.parse(saved) };
                } catch (error) {
                    state.settings = { ...defaultSettings };
                }
            }
            populateProviders();
            applySettingsToUI();
        }

        function loadMessages() {
            const saved = localStorage.getItem(MESSAGES_KEY);
            if (saved) {
                try {
                    state.messages = JSON.parse(saved);
                } catch (error) {
                    state.messages = [];
                }
            }
            renderMessages();
        }

        function saveSettings() {
            localStorage.setItem(SETTINGS_KEY, JSON.stringify(state.settings));
            elements.saveNotice.textContent = "配置已自动保存。";
            updateTags();
        }

        function saveMessages() {
            localStorage.setItem(MESSAGES_KEY, JSON.stringify(state.messages));
        }

        function applySettingsToUI() {
            elements.endpoint.value = state.settings.endpoint;
            elements.apiKey.value = state.settings.apiKey;
            elements.model.value = state.settings.model;
            elements.temperature.value = state.settings.temperature;
            elements.topP.value = state.settings.topP;
            elements.maxTokens.value = state.settings.maxTokens;
            elements.stream.checked = state.settings.stream;
            elements.systemPrompt.value = state.settings.systemPrompt;
            updateTags();
        }

        function populateProviders() {
            if (!elements.provider) {
                return;
            }
            elements.provider.innerHTML = "";
            const manualOption = document.createElement("option");
            manualOption.value = "";
            manualOption.textContent = "手动输入";
            elements.provider.appendChild(manualOption);
            PROVIDERS.forEach((provider) => {
                const option = document.createElement("option");
                option.value = provider.id;
                option.textContent = provider.label;
                elements.provider.appendChild(option);
            });
        }

        function applyProviderSelection(providerId) {
            const provider = PROVIDERS.find((item) => item.id === providerId);
            if (!provider) {
                return;
            }
            elements.endpoint.value = provider.endpoint;
            elements.model.value = provider.model;
            updateSettingsFromUI();
        }

        function updateTags() {
            elements.modelTag.textContent = `Model: ${state.settings.model || "-"}`;
            const endpoint = state.settings.endpoint || "-";
            elements.endpointTag.textContent = `Endpoint: ${endpoint.replace(/^https?:\/\//, "")}`;
        }

        function renderMessages() {
            elements.chatWindow.innerHTML = "";
            if (!state.messages.length) {
                elements.chatWindow.appendChild(elements.emptyState);
                elements.emptyState.style.display = "block";
                return;
            }
            elements.emptyState.style.display = "none";
            state.messages.forEach((message) => {
                elements.chatWindow.appendChild(createMessageNode(message));
            });
            scrollToBottom();
        }

        function createMessageNode(message) {
            const wrapper = document.createElement("div");
            wrapper.className = `message ${message.role}`;

            const avatar = document.createElement("div");
            avatar.className = `avatar ${message.role}`;
            avatar.textContent = message.role === "user" ? "你" : "AI";

            const bubble = document.createElement("div");
            bubble.className = "bubble";
            bubble.innerHTML = renderMarkdown(message.content || "");

            wrapper.appendChild(avatar);
            wrapper.appendChild(bubble);
            return wrapper;
        }

        function renderMarkdown(text) {
            const cleaned = stripThink(text);
            const html = marked.parse(cleaned);
            const safe = DOMPurify.sanitize(html);
            const container = document.createElement("div");
            container.innerHTML = safe;

            container.querySelectorAll("pre code").forEach((block) => {
                hljs.highlightElement(block);
                const pre = block.parentElement;
                const wrapper = document.createElement("div");
                wrapper.className = "code-block";
                const button = document.createElement("button");
                button.type = "button";
                button.textContent = "复制";
                button.addEventListener("click", () => {
                    navigator.clipboard.writeText(block.textContent || "");
                    button.textContent = "已复制";
                    setTimeout(() => (button.textContent = "复制"), 1200);
                });
                pre.replaceWith(wrapper);
                wrapper.appendChild(button);
                wrapper.appendChild(pre);
            });

            return container.innerHTML;
        }

        function stripThink(text) {
            const lower = text.toLowerCase();
            const start = lower.indexOf("<think>");
            const end = lower.indexOf("</think>");
            if (start === -1 || end === -1 || end < start) {
                return text;
            }
            const before = text.slice(0, start);
            const after = text.slice(end + "</think>".length);
            return `${before}${after}`.trim();
        }

        function scrollToBottom() {
            elements.chatWindow.scrollTop = elements.chatWindow.scrollHeight;
        }

        function updateSettingsFromUI() {
            state.settings.endpoint = elements.endpoint.value.trim();
            state.settings.apiKey = elements.apiKey.value.trim();
            state.settings.model = elements.model.value.trim();
            state.settings.temperature = Number(elements.temperature.value);
            state.settings.topP = Number(elements.topP.value);
            state.settings.maxTokens = Number(elements.maxTokens.value);
            state.settings.stream = elements.stream.checked;
            state.settings.systemPrompt = elements.systemPrompt.value;
            saveSettings();
        }

        function updateConnectionStatus(text, tone = "ready") {
            elements.connectionStatus.textContent = text;
            if (tone === "busy") {
                elements.connectionStatus.style.background = "#fbe3cb";
                elements.connectionStatus.style.color = "#7a3d10";
            } else if (tone === "error") {
                elements.connectionStatus.style.background = "#f4c7c2";
                elements.connectionStatus.style.color = "#6a1f1a";
            } else {
                elements.connectionStatus.style.background = "var(--accent-wash)";
                elements.connectionStatus.style.color = "var(--accent-strong)";
            }
        }

        async function sendMessage() {
            if (state.isStreaming) {
                return;
            }
            const content = elements.userInput.value.trim();
            if (!content) {
                return;
            }

            updateSettingsFromUI();

            const userMessage = { role: "user", content };
            state.messages.push(userMessage);
            elements.userInput.value = "";
            saveMessages();
            renderMessages();

            const assistantMessage = { role: "assistant", content: "" };
            state.messages.push(assistantMessage);
            renderMessages();
            saveMessages();

            const payloadMessages = [];
            if (state.settings.systemPrompt) {
                payloadMessages.push({ role: "system", content: state.settings.systemPrompt });
            }
            state.messages.forEach((message) => {
                if (message.role === "user" || message.role === "assistant") {
                    payloadMessages.push({ role: message.role, content: message.content });
                }
            });

            const payload = {
                model: state.settings.model,
                messages: payloadMessages,
                temperature: state.settings.temperature,
                top_p: state.settings.topP,
                max_tokens: state.settings.maxTokens,
                stream: state.settings.stream
            };

            const headers = {
                "Content-Type": "application/json"
            };
            if (state.settings.apiKey) {
                headers.Authorization = `Bearer ${state.settings.apiKey}`;
            }

            updateConnectionStatus("请求发送中...", "busy");
            state.isStreaming = true;
            state.controller = new AbortController();

            try {
                const response = await fetch(state.settings.endpoint, {
                    method: "POST",
                    headers,
                    body: JSON.stringify(payload),
                    signal: state.controller.signal
                });

                if (!response.ok) {
                    const errorText = await response.text();
                    throw new Error(`HTTP ${response.status}: ${errorText}`);
                }

                if (state.settings.stream) {
                    await handleStreamResponse(response, assistantMessage);
                } else {
                    const data = await response.json();
                    const text = data.choices?.[0]?.message?.content || "";
                    assistantMessage.content = text;
                    renderMessages();
                    saveMessages();
                }

                updateConnectionStatus("完成", "ready");
            } catch (error) {
                assistantMessage.content = `请求失败：${error.message}`;
                renderMessages();
                saveMessages();
                updateConnectionStatus("发生错误", "error");
            } finally {
                state.isStreaming = false;
                state.controller = null;
            }
        }

        async function handleStreamResponse(response, assistantMessage) {
            const reader = response.body.getReader();
            const decoder = new TextDecoder("utf-8");
            let buffer = "";

            while (true) {
                const { value, done } = await reader.read();
                if (done) {
                    break;
                }
                buffer += decoder.decode(value, { stream: true });
                const lines = buffer.split(/\r?\n/);
                buffer = lines.pop();

                for (const line of lines) {
                    const trimmed = line.trim();
                    if (!trimmed.startsWith("data:")) {
                        continue;
                    }
                    const data = trimmed.replace("data:", "").trim();
                    if (data === "[DONE]") {
                        return;
                    }
                    try {
                        const json = JSON.parse(data);
                        const delta = json.choices?.[0]?.delta?.content || json.choices?.[0]?.message?.content || "";
                        if (delta) {
                            assistantMessage.content += delta;
                            renderMessages();
                            saveMessages();
                        }
                    } catch (error) {
                        continue;
                    }
                }
            }
        }

        function stopStreaming() {
            if (state.controller) {
                state.controller.abort();
                updateConnectionStatus("已停止", "ready");
                state.isStreaming = false;
            }
        }

        function clearChat() {
            state.messages = [];
            saveMessages();
            renderMessages();
        }

        function resetSettings() {
            state.settings = { ...defaultSettings };
            applySettingsToUI();
            saveSettings();
        }

        elements.sendButton.addEventListener("click", sendMessage);
        elements.sendQuick.addEventListener("click", sendMessage);
        elements.stopStream.addEventListener("click", stopStreaming);
        elements.clearChat.addEventListener("click", clearChat);
        elements.resetSettings.addEventListener("click", resetSettings);
        elements.provider.addEventListener("change", (event) => {
            applyProviderSelection(event.target.value);
        });

        [
            elements.endpoint,
            elements.apiKey,
            elements.model,
            elements.temperature,
            elements.topP,
            elements.maxTokens,
            elements.stream,
            elements.systemPrompt
        ].forEach((input) => {
            input.addEventListener("change", updateSettingsFromUI);
        });

        elements.userInput.addEventListener("keydown", (event) => {
            const isComposing = state.isComposing || event.isComposing || event.keyCode === 229;
            if (event.key === "Enter" && !event.shiftKey && !isComposing) {
                event.preventDefault();
                sendMessage();
            }
        });

        elements.userInput.addEventListener("compositionstart", () => {
            state.isComposing = true;
        });

        elements.userInput.addEventListener("compositionend", () => {
            state.isComposing = false;
        });

        loadSettings();
        loadMessages();
    </script>
</body>
</html>
